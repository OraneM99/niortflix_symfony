{% extends 'base.html.twig' %}

{% block body_class %}serie-detail-page{% endblock %}
{% block title %}{{ serie.name }} | {{ parent() }}{% endblock %}

{% block stylesheets %}
    {% if not (app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial')) %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('assets/css/serie-detail.css') }}?v={{ 'now'|date('U') }}">
        <style>body.serie-detail-page{ background-color:#393E46; }</style>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}


{% block body %}
    {% if app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial') %}
        <link rel="stylesheet" href="{{ asset('assets/css/serie-detail.css') }}?v={{ 'now'|date('U') }}">
    {% endif %}

    {% set backdrop = asset(serie_params.backdrop_dir ~ '/' ~ serie.backdrop) %}
    {% set status = serie.status|lower %}
    {% set statusLabel = status == 'returning' ? 'En cours'
        : (status == 'ended' ? 'Terminée'
        : (status == 'cancelled' ? 'Annulée' : serie.status)) %}

    <div class="detail-sheet{% if app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial') %} is-modal{% endif %}">

        {# --- HERO --- #}
        <section class="series-hero" style="--hero: url('{{ backdrop }}')">
            <div class="hero-inner">
                <div class="hero-title">
                    <h1>{{ serie.name }}</h1>

                    {% if serie.genres is defined and serie.genres|length %}
                        <div class="hero-genres">
                            {% for g in serie.genres %}
                                <a href="{{ path('serie_liste', { genre: g }) }}" class="genre-badge">{{ g }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="hero-meta">
                        <div class="meta-item">
                            <img class="icon-16" src="{{ asset('icons/calendar.png') }}" alt="">
                            <span>
                                {{ serie.firstAirDate ? serie.firstAirDate|date('d/m/Y') : 'Date inconnue' }}
                                {% if serie.lastAirDate %} – {{ serie.lastAirDate|date('d/m/Y') }}{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-badge">{{ statusLabel }}</div>
            <span class="hero-score">
                <img src="{{ asset('icons/star.png') }}" alt="">
                {{ serie.vote|default('N/A') }}
            </span>
        </section>

        {# --- Streaming --- #}
        <section class="section">
            <h2>Où regarder</h2>
            <div class="watch-list">
                {% if watchLinks is not empty %}
                    {% for p in watchLinks %}
                        {% set iconPath = p.icon starts with('http') ? p.icon : asset(p.icon) %}
                        <a href="{{ p.url }}" class="watch-chip is-{{ p.key }}" target="_blank" rel="noopener">
                            <img src="{{ iconPath }}" alt="{{ p.label }}">
                            {{ p.label }}
                        </a>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Aucun lien de streaming disponible.</p>
                {% endif %}
            </div>

            {% if is_granted('ROLE_ADMIN') and watchLinks is empty %}
                <div class="d-flex justify-content-end mt-2">
                    <button type="button" class="btn btn-add-link" data-bs-toggle="modal" data-bs-target="#addLinkModal">
                        ➕ Ajouter un lien
                    </button>
                </div>

                <div class="modal fade" id="addLinkModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content modal-dark">
                            <div class="modal-header border-0">
                                <h5 class="modal-title text-white">Ajouter un lien de streaming</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-white">
                                {{ form_start(linkForm, { attr: { class: 'needs-validation', novalidate: 'novalidate' } }) }}
                                {{ form_row(linkForm.provider) }}
                                {{ form_row(linkForm.url) }}
                                {{ form_row(linkForm.enabled) }}
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button type="button" class="btn btn-ghost-teal" data-bs-dismiss="modal">Annuler</button>
                                    <button type="submit" class="btn btn-teal">Ajouter</button>
                                </div>
                                {{ form_end(linkForm) }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </section>

        {# --- Synopsis --- #}
        {% if serie.overview %}
            <section class="section">
                <h2>Synopsis</h2>
                <p class="synopsis">{{ serie.overview }}</p>
            </section>
        {% endif %}

        {# --- Onglets Distribution / Suivi --- #}
        <div class="tabs" data-tabs>
            <div class="tab-triggers">
                <button type="button" class="tab-trigger is-active" data-tab="cast">Distribution</button>
                <button type="button" class="tab-trigger" data-tab="track">Suivi</button>
            </div>

            <div class="tab-panel is-active" data-panel="cast">
                <div class="cast-grid">
                    {% for c in contributors %}
                        <div class="cast-card{% if not c.picture %} no-photo{% endif %}">
                            {% if c.picture %}
                                <img src="{{ asset(c.picture) }}" class="cast-photo" alt="{{ c.name }}">
                            {% endif %}
                            <div class="cast-overlay">
                                <a href="{{ path('contributor_show', {id: c.id}) }}">
                                    {{ c.name }}
                                </a>

                                <div class="cast-role">{{ c.role }}</div>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">Aucun acteur enregistré.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-panel" data-panel="track">
                <div class="track-actions">
                    <a href="{{ path('serie_favorite', {id: serie.id}) }}"
                       class="btn-primary js-favorite"
                       data-url="{{ path('serie_favorite', {id: serie.id}) }}"
                       data-token="{{ csrf_token('favorite' ~ serie.id) }}">
                        <img src="{{ asset('icons/heart.png') }}" alt="">
                        {{ app.user and app.user.hasFavoriteSerie(serie) ? 'Retirer des favoris' : 'Ajouter aux favoris' }}
                    </a>
                    <a href="{{ path('serie_ignore', {id: serie.id}) }}" class="btn-ghost">
                        <img class="icon-16" src="{{ asset('icons/stop.png') }}" alt=""> Ignorer
                    </a>
                    <a href="#" class="btn-ghost">
                        <img class="icon-16" src="{{ asset('icons/check.png') }}" alt=""> Marquer comme vu
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
