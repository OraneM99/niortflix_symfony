{% extends 'base.html.twig' %}
{% block body_class %}serie-detail-page{% endblock %}

{% block title %}{{ serie.name }} | {{ parent() }}{% endblock %}

{% block stylesheets %}
    {% if not app.request.isXmlHttpRequest() and not app.request.query.get('partial') %}
        {{ parent() }}
    {% endif %}
    <style>
        body.serie-detail-page {
            --backdrop-image: url("{{ asset(serie_params.backdrop_dir ~ '/' ~ serie.backdrop) }}");
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('assets/js/serie-detail.js') }}" defer></script>
{% endblock %}

{% block body %}
    <div class="serie-detail-container">
        <a href="{{ path('serie_liste') }}" class="btn-back">&lt; Retour</a>

        <!-- Header -->
        <div class="serie-header">
            <div class="serie-meta">
                {{ serie.name }}
                <span class="genre-separator">|</span>
                <span class="serie-genres">{{ serie.genres|join(' · ') }}</span>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="serie-main-content">
            <!-- Poster -->
            <div class="poster-section">
                <img src="{{ asset(serie_params.poster_dir ~ '/' ~ serie.poster) }}"
                     alt="{{ serie.name }}"
                     class="poster-img">

                {# Statut en haut à gauche #}
                {% set status = serie.status|lower %}
                <span class="status-overlay">
                {% if status == 'returning' %}
                    En cours
                {% elseif status == 'ended' %}
                    Terminée
                {% elseif status == 'cancelled' %}
                    Annulée
                {% else %}
                    {{ status }}
                {% endif %}
            </span>
            </div>

            <!-- Infos -->
            <div class="content-section">
                <div class="serie-info">
                    <h1 class="serie-title">{{ serie.name }}</h1>

                    <!-- Description -->
                    <p class="serie-overview">{{ serie.overview }}</p>

                    <!-- Dates -->
                    <div class="info-row">
                        <img src="{{ asset('icons/calendar.png') }}" alt="Calendrier" class="icon-btn">
                        <div class="date-range">
                            <span>{{ serie.firstAirDate|date('d/m/Y') }}</span>
                            {% if serie.status in ['ended', 'cancelled'] and serie.lastAirDate %}
                                <span> - {{ serie.lastAirDate|date('d/m/Y') }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Actions sociales -->
                    <div class="secondary-actions">
                        <a href="#" id="shareButton" class="action-link">
                            <img src="{{ asset('icons/share.png') }}" alt="Partager" class="icon-btn">
                            <span>Partager</span>
                        </a>
                        <a href="#" id="favoriteButton" class="action-link">
                            <img src="{{ asset('icons/heart.png') }}" alt="Favoris" class="icon-btn">
                            <span>Ajouter à mes favoris</span>
                        </a>
                    </div>

                    <!-- Boutons principaux -->
                    <div class="primary-actions">
                        <button id="watchButton" class="btn-watch">
                            <img src="{{ asset('icons/play.png') }}" alt="Regarder" class="icon-btn">
                            Regarder
                        </button>
                        <button id="trailerButton" class="btn-trailer">
                            <img src="{{ asset('icons/trailer.png') }}" alt="Bande-annonce" class="icon-btn">
                            Bande-annonce
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribution -->
        <div class="distribution-section">
            <div class="distribution-header">
                <h2 class="distribution-title">Distribution</h2>
                {% if is_granted('ROLE_ADMIN') %}
                    <button class="btn-add-contributor">
                        <img src="{{ asset('icons/add-user.png') }}" alt="Ajouter" class="icon-btn">
                        Ajouter un membre
                    </button>
                {% endif %}
            </div>
        </div>

        <!-- Admin actions -->
        <div class="admin-actions">
            {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('serie_update', { id: serie.id }) }}" class="btn-outline">Modifier la série</a>
                <a href="{{ path('serie_delete', { id: serie.id, token: csrf_token('delete' ~ serie.id) }) }}"
                   class="btn-danger"
                   onclick="return confirm('Voulez-vous vraiment supprimer cette série ?');">
                    Supprimer la série
                </a>
            {% endif %}
        </div>
    </div>

    <style>
        .poster-section {
            position: relative;
            width: 350px;
            height: 500px;
            flex: 0 0 auto;
        }

        .poster-section::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            border-radius: 12px;
        }

        .poster-section .poster-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: block;
        }

        .status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #7F8CAA;
            color: #fff;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 2;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .icon-btn {
            width: 18px;
            height: 18px;
            object-fit: contain;
            display: inline-block;
        }

        .stars img {
            width: 16px;
            height: 16px;
        }
    </style>
{% endblock %}
