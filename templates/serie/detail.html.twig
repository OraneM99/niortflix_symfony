{% extends 'base.html.twig' %}

{% block body_class %}serie-detail-page{% endblock %}
{% block title %}{{ serie.name }} | {{ parent() }}{% endblock %}

{% block stylesheets %}
    {% if not (app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial')) %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('assets/css/serie-detail.css') }}?v={{ 'now'|date('U') }}">
        <style>body.serie-detail-page{ background-color:#393E46; }</style>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}

{% block body %}
    {% if app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial') %}
        <link rel="stylesheet" href="{{ asset('assets/css/serie-detail.css') }}?v={{ 'now'|date('U') }}">
    {% endif %}

    {% set backdrop = asset(serie_params.backdrop_dir ~ '/' ~ serie.backdrop) %}
    {% set status = serie.status|lower %}
    {% set statusLabel = status == 'returning' ? 'En cours'
        : (status == 'ended' ? 'Terminée'
        : (status == 'cancelled' ? 'Annulée' : serie.status)) %}

    <div class="detail-sheet{% if app.request.isXmlHttpRequest() or app.request.query.getBoolean('partial') %} is-modal{% endif %}">

        {# --- HERO --- #}
        <section class="series-hero" style="--hero: url('{{ backdrop }}')">
            <div class="hero-inner">
                <div class="hero-title">
                    <h1>{{ serie.name }}</h1>

                    {% if serie.genres is defined and serie.genres|length %}
                        <div class="hero-genres">
                            {% for g in serie.genres %}
                                <a href="{{ path('serie_liste', { genre: g }) }}" class="genre-badge">{{ g }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="hero-meta">
                        <div class="meta-item">
                            <img class="icon-16" src="{{ asset('icons/calendar.png') }}" alt="">
                            <span>
                                {{ serie.firstAirDate ? serie.firstAirDate|date('d F Y') : 'Date inconnue' }}
                                {% if serie.lastAirDate %} – {{ serie.lastAirDate|date('d F Y') }}{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-badge">{{ statusLabel }}</div>
            <span class="hero-score">
                <img src="{{ asset('icons/star.png') }}" alt="">
                {{ serie.vote|default('N/A') }}
            </span>
        </section>

        {# --- Streaming --- #}
        <section class="section">
            <h2>Où regarder</h2>
            <div class="watch-list">
                {% if watchLinks is not empty %}
                    {% for p in watchLinks %}
                        {% set iconPath = p.icon starts with('http') ? p.icon : asset(p.icon) %}
                        <a href="{{ p.url }}" class="watch-chip is-{{ p.key }}" target="_blank" rel="noopener">
                            <img src="{{ iconPath }}" alt="{{ p.label }}">
                            {{ p.label }}
                        </a>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Aucun lien de streaming disponible.</p>
                {% endif %}
            </div>

            {# Formulaire d'ajout de lien (admin uniquement) #}
            {% if is_granted('ROLE_ADMIN') and linkForm is defined %}
                <div class="streaming-form-wrapper">
                    <h3>Ajouter un lien de streaming</h3>

                    {# Liste des liens existants #}
                    {% if streamingLinks is defined and streamingLinks|length %}
                        <div class="existing-links">
                            {% for link in streamingLinks %}
                                <div class="streaming-link-item">
                                    <div class="link-info">
                                        <span class="provider-name">{{ link.provider|capitalize }}</span>
                                        <a href="{{ link.url }}" target="_blank" rel="noopener" class="link-url">{{ link.url }}</a>
                                        {% if not link.enabled %}
                                            <span class="status-disabled">Désactivé</span>
                                        {% endif %}
                                    </div>
                                    <form method="post"
                                          action="{{ path('serie_link_delete', { id: serie.id, index: loop.index0 }) }}"
                                          class="delete-form"
                                          onsubmit="return confirm('Supprimer ce lien ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('del_link_' ~ serie.id ~ '_' ~ loop.index0) }}">
                                        <button type="submit" class="btn-delete">×</button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# Formulaire d'ajout #}
                    {{ form_start(linkForm, {
                        attr: { class: 'streaming-add-form' }
                    }) }}
                    <div class="form-row">
                        <div class="form-group">
                            {{ form_label(linkForm.provider) }}
                            {{ form_widget(linkForm.provider, { attr: { class: 'form-control' } }) }}
                        </div>
                        <div class="form-group">
                            {{ form_label(linkForm.url) }}
                            {{ form_widget(linkForm.url, { attr: { class: 'form-control', placeholder: 'https://...' } }) }}
                        </div>
                        <div class="form-group checkbox-group">
                            {{ form_widget(linkForm.enabled, { attr: { class: 'form-check-input' } }) }}
                            {{ form_label(linkForm.enabled, null, { label_attr: { class: 'form-check-label' } }) }}
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-add-link">Ajouter le lien</button>
                    </div>
                    {{ form_end(linkForm) }}
                </div>
            {% endif %}
        </section>

        {# --- Synopsis --- #}
        {% if serie.overview %}
            <section class="section">
                <h2>Synopsis</h2>
                <p class="synopsis">{{ serie.overview }}</p>
            </section>
        {% endif %}

        {# --- Onglets Distribution / Suivi --- #}
        <div class="tabs" data-tabs>
            <div class="tab-triggers">
                <button type="button" class="tab-trigger is-active" data-tab="cast">Distribution</button>
                <button type="button" class="tab-trigger" data-tab="track">Suivi</button>
            </div>

            <div class="tab-panel is-active" data-panel="cast">
                <div class="cast-grid">
                    {% for c in contributors %}
                        <div class="cast-card{% if not c.picture %} no-photo{% endif %}">
                            {% if c.picture %}
                                <img src="{{ asset(c.picture) }}" class="cast-photo" alt="{{ c.name }}">
                            {% endif %}
                            <div class="cast-overlay">
                                <a href="{{ path('contributor_show', {id: c.id}) }}">
                                    {{ c.name }}
                                </a>

                                <div class="cast-role">{{ c.role }}</div>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">Aucun acteur enregistré.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-panel" data-panel="track">
                <div class="track-actions">
                    <a href="{{ path('serie_favorite', {id: serie.id}) }}"
                       class="btn-primary js-favorite"
                       data-url="{{ path('serie_favorite', {id: serie.id}) }}"
                       data-token="{{ csrf_token('favorite' ~ serie.id) }}">
                        <img src="{{ asset('icons/heart.png') }}" alt="">
                        {{ app.user and app.user.hasFavoriteSerie(serie) ? 'Retirer des favoris' : 'Ajouter aux favoris' }}
                    </a>
                    <a href="{{ path('serie_ignore', {id: serie.id}) }}" class="btn-ghost">
                        <img class="icon-16" src="{{ asset('icons/stop.png') }}" alt=""> Ignorer
                    </a>
                    <a href="#" class="btn-ghost">
                        <img class="icon-16" src="{{ asset('icons/check.png') }}" alt=""> Marquer comme vu
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
